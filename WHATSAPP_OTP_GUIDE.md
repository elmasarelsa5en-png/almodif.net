# 🔐 نظام التحقق بالواتساب والتسجيل

## ✅ المميزات الجديدة

### 1️⃣ التحقق بكود OTP عند التسجيل
- عند تسجيل نزيل جديد، يُرسل كود من 6 أرقام على الواتساب
- الكود صالح لمدة 10 دقائق
- يجب إدخال الكود الصحيح لإتمام التسجيل
- يحفظ النزيل في قاعدة البيانات بحالة `verified: true` بعد التحقق

### 2️⃣ نسيت كلمة المرور
- إذا نسى النزيل كلمة المرور، يدخل:
  - الاسم الكامل
  - رقم الهوية الوطنية
- يُرسل كلمة المرور على الواتساب مباشرة

---

## 📱 كيفية تشغيل الخدمة

### الخطوة 1: تشغيل خدمة الواتساب
```bash
# انقر على الملف
start-whatsapp-service.bat
```

سيتم:
- تثبيت المكتبات المطلوبة تلقائيًا
- تشغيل الخادم على البورت 3002
- ظهور QR Code للمسح

### الخطوة 2: ربط الواتساب
افتح المتصفح على:
```
http://localhost:3002/api/qr
```

امسح الـ QR Code باستخدام الواتساب:
1. افتح الواتساب
2. اذهب للإعدادات > الأجهزة المرتبطة
3. امسح الكود

### الخطوة 3: تشغيل التطبيق الرئيسي
```bash
npm run dev
```

---

## 🔧 التكوين

### ملفات الواتساب
- `server/whatsapp-service.js` - خادم الواتساب الرئيسي
- `server/whatsapp-data/` - بيانات الجلسة (تُنشأ تلقائيًا)
- `src/app/api/send-otp/route.ts` - نقطة النهاية لإرسال OTP

### البورتات
- **التطبيق الرئيسي**: 3000
- **خدمة الواتساب**: 3002

---

## 📋 سير العمل

### تسجيل نزيل جديد
```
1. النزيل يملأ البيانات (الاسم، الهوية، الجوال، كلمة المرور)
2. يضغط "تسجيل حساب جديد"
3. يُولّد كود OTP عشوائي (6 أرقام)
4. يُرسل على الواتساب
5. النزيل يدخل الكود
6. إذا صحيح: يُحفظ الحساب بحالة verified=true
7. إذا خاطئ أو منتهي: رسالة خطأ
```

### نسيان كلمة المرور
```
1. النزيل يختار "نسيت كلمة المرور"
2. يدخل الاسم ورقم الهوية
3. يُبحث في قاعدة البيانات
4. إذا وُجد: تُرسل كلمة المرور على الواتساب
5. إذا لم يُوجد: رسالة "الحساب غير موجود"
```

---

## 🌐 API Endpoints

### إرسال OTP
```typescript
POST /api/send-otp

Body:
{
  "phone": "0501234567",    // رقم الجوال
  "code": "123456",          // الكود (OTP أو كلمة المرور)
  "type": "verification"     // أو "password"
}

Response:
{
  "success": true,
  "message": "OTP sent successfully"
}
```

### حالة الواتساب
```
GET http://localhost:3002/api/status

Response:
{
  "status": "authenticated",
  "phoneNumber": "966501234567"
}
```

---

## ⚠️ ملاحظات مهمة

### 1. تشغيل الخدمة قبل الاستخدام
تأكد من تشغيل `start-whatsapp-service.bat` قبل تجربة التسجيل أو نسيان كلمة المرور

### 2. مسح QR Code مرة واحدة فقط
بعد المسح الأول، ستبقى الجلسة محفوظة في `server/whatsapp-data/`

### 3. أرقام الجوال السعودية
- يُضاف تلقائيًا 966 للأرقام التي تبدأ بـ 5
- مثال: `0501234567` يصبح `966501234567`

### 4. مدة صلاحية OTP
- 10 دقائق فقط
- بعدها يجب طلب كود جديد

---

## 🐛 استكشاف الأخطاء

### "WhatsApp service is not available"
✅ الحل: تأكد من تشغيل `start-whatsapp-service.bat`

### "Failed to send OTP"
✅ الحل: افحص:
- هل الواتساب متصل؟ (افتح `/api/status`)
- هل رقم الجوال صحيح؟
- هل الإنترنت متصل؟

### "الحساب غير موجود" (في نسيان كلمة المرور)
✅ الحل: تأكد من:
- الاسم مطابق تمامًا للموجود في قاعدة البيانات
- رقم الهوية صحيح

---

## 📁 الملفات المعدّلة

### ملفات جديدة
- ✅ `server/package.json`
- ✅ `start-whatsapp-service.bat`
- ✅ `src/app/api/send-otp/route.ts`
- ✅ هذا الملف (WHATSAPP_OTP_GUIDE.md)

### ملفات معدّلة
- ✅ `server/whatsapp-service.js` - إضافة endpoint `/api/send-otp`
- ✅ `src/app/guest-app/login/page.tsx` - إضافة نماذج OTP ونسيان كلمة المرور

---

## 🚀 البدء السريع

```bash
# 1. شغّل خدمة الواتساب
start-whatsapp-service.bat

# 2. افتح المتصفح وامسح QR
http://localhost:3002/api/qr

# 3. في terminal آخر، شغّل التطبيق
npm run dev

# 4. افتح صفحة تسجيل النزلاء
http://localhost:3000/guest-app/login
```

---

## ✅ جاهز للاستخدام!

الآن يمكنك:
1. تسجيل نزلاء جدد مع التحقق بالواتساب
2. استعادة كلمات المرور عبر الواتساب
3. حماية الحسابات من التسجيلات الوهمية

**تم بحمد الله ✨**
