'use client';

import { useRouter } from 'next/navigation';
import { useEffect, useMemo, useState } from 'react';
import {
  MessageSquare,
  Plus,
  Bot,
  ClipboardList,
  Send,
  X,
  ArrowRight,
  Phone,
  Clock,
  User,
  FileText,
  CheckCircle,
  AlertCircle,
  TrendingUp,
  Users,
  Briefcase,
  LogOut,
  LogIn,
  BarChart3,
  Trash2,
  Settings,
  Filter,
  Download,
  Upload,
  Search,
  Eye,
  Star,
  Award,
  Activity,
  Calendar,
  MapPin,
  Mail,
  Zap,
  Target,
  PieChart,
  LineChart,
  PlayCircle,
  Headphones,
  Shield,
  ChevronDown,
  ChevronUp,
  MoreVertical,
  RefreshCw,
  Archive,
  Tag,
  Sparkles
} from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';

type ContactStatus = 'active' | 'inactive' | 'blocked' | 'pending';
type MessageStatus = 'sent' | 'delivered' | 'read' | 'failed';
type RequestType = 'booking' | 'complaint' | 'cleaning' | 'coffee' | 'laundry';
type EmployeeStatus = 'available' | 'busy' | 'offline' | 'on-break';
type IssueStatus = 'open' | 'in-progress' | 'resolved' | 'closed';
type IssuePriority = 'low' | 'medium' | 'high' | 'urgent';

interface WhatsAppContact {
  id: string;
  name: string;
  phone: string;
  status: ContactStatus;
  lastMessage: string;
  lastMessageTime: string;
  messageCount: number;
  notes: string;
  createdAt: string;
  assignedEmployeeId?: string;
  tags: string[];
  priority: IssuePriority;
  customerStage: 'trial' | 'follow-up' | 'purchase' | 'rejected';
  satisfactionScore?: number;
}

interface WhatsAppMessage {
  id: string;
  contactId: string;
  message: string;
  status: MessageStatus;
  timestamp: string;
  direction: 'incoming' | 'outgoing';
  isBot?: boolean;
  employeeId?: string;
  employeeName?: string;
  aiGenerated?: boolean;
  attachments?: Array<{ type: string; url: string; name: string }>;
}

interface BotRequest {
  id: string;
  contactId: string;
  contactName: string;
  contactPhone: string;
  type: RequestType;
  details: Record<string, any>;
  status: 'pending' | 'processing' | 'completed';
  createdAt: string;
  completedAt?: string;
  assignedEmployeeId?: string;
}

interface Employee {
  id: string;
  name: string;
  email: string;
  phone: string;
  status: EmployeeStatus;
  role: 'admin' | 'agent' | 'supervisor';
  avatar?: string;
  stats: {
    totalChats: number;
    totalMessages: number;
    avgResponseTime: number;
    satisfactionScore: number;
    activeChats: number;
    resolvedIssues: number;
  };
  workingHours: {
    start: string;
    end: string;
    totalHoursToday: number;
  };
  lastActive: string;
}

interface Issue {
  id: string;
  contactId: string;
  title: string;
  description: string;
  status: IssueStatus;
  priority: IssuePriority;
  category: string;
  assignedEmployeeId?: string;
  createdAt: string;
  resolvedAt?: string;
  solutionSteps: string[];
  solutionVideoUrl?: string;
  relatedChatIds: string[];
  frequency: number;
}

interface AnalyticsData {
  totalContacts: number;
  activeChats: number;
  totalMessages: number;
  avgResponseTime: number;
  satisfactionScore: number;
  resolvedIssues: number;
  pendingRequests: number;
  dailyStats: Array<{ date: string; messages: number; chats: number }>;
  employeePerformance: Array<{ employeeId: string; name: string; score: number; chats: number }>;
}

const STORAGE_CONTACTS_KEY = 'whatsapp_contacts';
const STORAGE_MESSAGES_KEY = 'whatsapp_messages';
const STORAGE_BOT_REQUESTS_KEY = 'bot_requests';
const STORAGE_EMPLOYEES_KEY = 'crm_employees';
const STORAGE_ISSUES_KEY = 'crm_issues';

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
const DEFAULT_EMPLOYEES: Employee[] = [
  {
    id: 'emp_001',
    name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯',
    email: 'ahmed@hotel.com',
    phone: '+201012345678',
    status: 'available',
    role: 'admin',
    avatar: 'ğŸ‘¨â€ğŸ’¼',
    stats: {
      totalChats: 145,
      totalMessages: 892,
      avgResponseTime: 2.3,
      satisfactionScore: 4.8,
      activeChats: 8,
      resolvedIssues: 67
    },
    workingHours: {
      start: '08:00',
      end: '17:00',
      totalHoursToday: 6.5
    },
    lastActive: new Date().toISOString()
  },
  {
    id: 'emp_002',
    name: 'ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯',
    email: 'fatima@hotel.com',
    phone: '+201098765432',
    status: 'busy',
    role: 'agent',
    avatar: 'ğŸ‘©â€ğŸ’¼',
    stats: {
      totalChats: 98,
      totalMessages: 567,
      avgResponseTime: 3.1,
      satisfactionScore: 4.5,
      activeChats: 12,
      resolvedIssues: 45
    },
    workingHours: {
      start: '09:00',
      end: '18:00',
      totalHoursToday: 5.2
    },
    lastActive: new Date(Date.now() - 300000).toISOString()
  },
  {
    id: 'emp_003',
    name: 'Ù…Ø­Ù…ÙˆØ¯ Ø¹Ù„ÙŠ',
    email: 'mahmoud@hotel.com',
    phone: '+201156789012',
    status: 'available',
    role: 'agent',
    avatar: 'ğŸ‘¨â€ğŸ’»',
    stats: {
      totalChats: 123,
      totalMessages: 734,
      avgResponseTime: 2.8,
      satisfactionScore: 4.7,
      activeChats: 5,
      resolvedIssues: 58
    },
    workingHours: {
      start: '08:30',
      end: '17:30',
      totalHoursToday: 7.0
    },
    lastActive: new Date(Date.now() - 120000).toISOString()
  }
];

// Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© ÙˆØ§Ù„Ø­Ù„ÙˆÙ„
const COMMON_ISSUES = [
  {
    category: 'ÙÙ†ÙŠØ©',
    title: 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
    solution: 'Ø§Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ø´ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰',
    videoUrl: 'https://youtube.com/watch?v=example1'
  },
  {
    category: 'Ø®Ø¯Ù…Ø© Ø§Ù„ØºØ±Ù',
    title: 'ØªØ£Ø®Ø± Ø§Ù„ØªÙ†Ø¸ÙŠÙ',
    solution: 'Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©',
    videoUrl: ''
  },
  {
    category: 'Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
    title: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
    solution: 'Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙˆØªØµØ­ÙŠØ­Ù‡Ø§',
    videoUrl: 'https://youtube.com/watch?v=example3'
  }
];

const REQUEST_TYPES: Array<{ value: RequestType; label: string; icon: string }> = [
  { value: 'booking', label: 'Ø­Ø¬Ø² ØºØ±ÙØ©', icon: 'ğŸ¨' },
  { value: 'complaint', label: 'Ø´ÙƒÙˆÙ‰', icon: 'âš ï¸' },
  { value: 'cleaning', label: 'ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØºØ±ÙØ©', icon: 'ğŸ§¹' },
  { value: 'coffee', label: 'Ø·Ù„Ø¨ ÙƒÙˆÙÙŠ', icon: 'â˜•' },
  { value: 'laundry', label: 'ØºØ³ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¨Ø³', icon: 'ğŸ‘•' }
];

const BOT_CONVERSATIONS: Record<RequestType, string[]> = {
  booking: [
    'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§! ğŸ¨ Ù†ÙˆØ¯ ØªÙˆÙÙŠØ± Ø£ÙØ¶Ù„ Ø®Ø¯Ù…Ø§ØªÙ†Ø§ Ù„Ùƒ',
    'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø§Ù„Ø°ÙŠÙ† Ø³ØªÙ‚ÙŠÙ…ÙˆÙ†ØŸ',
    'Ù…Ø§ Ù‡Ùˆ Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¯ÙŠÙƒØŸ (Ø³ØªØ§Ù†Ø¯Ø±Ø¯/Ø¯ÙŠÙ„ÙˆÙƒØ³/Ø³ÙˆÙŠØª)',
    'Ù…Ø§ ØªØ§Ø±ÙŠØ® Ø¯Ø®ÙˆÙ„ ÙˆØ®Ø±ÙˆØ¬ Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©ØŸ',
    'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ âœ…'
  ],
  complaint: [
    'Ù†Ø£Ø³Ù Ù„Ø³Ù…Ø§Ø¹ Ø´ÙƒÙˆØ§Ùƒ! ğŸ˜” Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ',
    'ÙŠØ±Ø¬Ù‰ ØªÙØµÙŠÙ„ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„',
    'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø²ÙŠØ§Ø±Ø© ÙØ±ÙŠÙ‚ Ø§Ù„ØµÙŠØ§Ù†Ø© Ù„Ù„ØºØ±ÙØ©ØŸ',
    'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªØ¹Ø§ÙˆÙ†Ùƒ! Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø´ÙƒÙˆØ§Ùƒ ÙÙˆØ±Ø§Ù‹ âœ…'
  ],
  cleaning: [
    'Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ! ğŸ§¹ Ø³Ø¹ÙŠØ¯ Ø¨Ø·Ù„Ø¨Ùƒ',
    'Ù…Ø§ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ©ØŸ',
    'Ù…Ø§ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù„Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŸ (Ø·Ø§Ø±Ø¦/Ø¹Ø§Ø¯ÙŠ)',
    'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„ØªÙ†Ø¸ÙŠÙ! Ø³ÙŠØµÙ„ Ø§Ù„ÙØ±ÙŠÙ‚ Ø®Ù„Ø§Ù„ 15-30 Ø¯Ù‚ÙŠÙ‚Ø© âœ…'
  ],
  coffee: [
    'Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ø·Ù„Ø¨Ùƒ Ù…Ù† Ø§Ù„ÙƒÙˆÙÙŠ Ø´ÙˆØ¨! â˜•',
    'Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªÙˆØ¯ Ø·Ù„Ø¨Ù‡ØŸ',
    'Ù…Ø§ Ø±Ù‚Ù… Ø§Ù„ØºØ±ÙØ© Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ØŸ',
    'Ø´ÙƒØ±Ø§Ù‹! Ø³ÙŠØµÙ„ Ø·Ù„Ø¨Ùƒ Ø®Ù„Ø§Ù„ 15-20 Ø¯Ù‚ÙŠÙ‚Ø© âœ…'
  ],
  laundry: [
    'Ø®Ø¯Ù…Ø© Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ù…ØªÙ…ÙŠØ²Ø©! ğŸ‘•',
    'ÙƒÙ… Ù‚Ø·Ø¹Ø© Ù…Ù„Ø§Ø¨Ø³ ØªØ±ÙŠØ¯ ØºØ³Ù„Ù‡Ø§ØŸ',
    'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø®Ø¯Ù…Ø© Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ØŸ (Ø¥Ø¶Ø§ÙÙŠ Ù…Ù‚Ø§Ø¨Ù„ Ø±Ø³ÙˆÙ…)',
    'ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ùƒ! Ø³ÙŠØªÙ… ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø© âœ…'
  ]
};

const uid = () => `${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;

function useLocalStorage<T>(key: string, initial: T) {
  const [state, setState] = useState<T>(initial);
  useEffect(() => {
    try {
      const stored = localStorage.getItem(key);
      if (stored) setState(JSON.parse(stored));
    } catch (e) {
      console.error(`Storage error: ${key}`, e);
    }
  }, [key]);
  useEffect(() => {
    try {
      localStorage.setItem(key, JSON.stringify(state));
    } catch (e) {
      console.error(`Storage error: ${key}`, e);
    }
  }, [key, state]);
  return [state, setState] as const;
}

export default function WhatsAppCRMPage() {
  const router = useRouter();
  const [contacts, setContacts] = useLocalStorage<WhatsAppContact[]>(STORAGE_CONTACTS_KEY, []);
  const [messages, setMessages] = useLocalStorage<WhatsAppMessage[]>(STORAGE_MESSAGES_KEY, []);
  const [botRequests, setBotRequests] = useLocalStorage<BotRequest[]>(STORAGE_BOT_REQUESTS_KEY, []);
  const [employees, setEmployees] = useLocalStorage<Employee[]>(STORAGE_EMPLOYEES_KEY, DEFAULT_EMPLOYEES);
  const [issues, setIssues] = useLocalStorage<Issue[]>(STORAGE_ISSUES_KEY, []);

  const [selectedContactId, setSelectedContactId] = useState<string | null>(null);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [messageText, setMessageText] = useState('');
  const [activeTab, setActiveTab] = useState<'messages' | 'requests' | 'employees' | 'analytics' | 'issues'>('messages');
  const [botMode, setBotMode] = useState(false);
  const [aiMode, setAiMode] = useState(false);
  const [botRequestType, setBotRequestType] = useState<RequestType>('booking');
  const [botStep, setBotStep] = useState(0);
  const [showEmployeeDetails, setShowEmployeeDetails] = useState(false);
  const [showIssueDialog, setShowIssueDialog] = useState(false);
  const [newIssue, setNewIssue] = useState({ title: '', description: '', category: '', priority: 'medium' as IssuePriority });

  const stats = useMemo(() => ({
    totalContacts: contacts.length,
    activeContacts: contacts.filter((c) => c.status === 'active').length,
    totalMessages: messages.length,
    botRequests: botRequests.length,
    pendingRequests: botRequests.filter((r) => r.status === 'pending').length,
    totalEmployees: employees.length,
    availableEmployees: employees.filter((e) => e.status === 'available').length,
    totalIssues: issues.length,
    openIssues: issues.filter((i) => i.status === 'open' || i.status === 'in-progress').length,
    avgSatisfaction: contacts.reduce((sum, c) => sum + (c.satisfactionScore || 0), 0) / contacts.filter(c => c.satisfactionScore).length || 0,
    avgResponseTime: employees.reduce((sum, e) => sum + e.stats.avgResponseTime, 0) / employees.length || 0
  }), [contacts, messages, botRequests, employees, issues]);

  const filteredContacts = useMemo(() => contacts.filter((contact) => {
    return contact.name.toLowerCase().includes(searchTerm.toLowerCase()) || contact.phone.includes(searchTerm);
  }), [contacts, searchTerm]);

  const selectedContact = selectedContactId ? contacts.find((c) => c.id === selectedContactId) : null;
  const contactMessages = selectedContactId ? messages.filter((m) => m.contactId === selectedContactId).sort((a, b) => new Date(a.timestamp).getTime() - new Date(b.timestamp).getTime()) : [];

  const handleAddContact = () => {
    const newContact: WhatsAppContact = {
      id: uid(),
      name: 'Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯',
      phone: '',
      status: 'active',
      lastMessage: '',
      lastMessageTime: new Date().toISOString(),
      messageCount: 0,
      notes: '',
      createdAt: new Date().toISOString(),
      tags: [],
      priority: 'medium',
      customerStage: 'trial',
      satisfactionScore: undefined
    };
    setContacts((prev) => [...prev, newContact]);
  };

  const handleSendMessage = () => {
    if (!selectedContact || !messageText.trim()) return;

    const newMessage: WhatsAppMessage = {
      id: uid(),
      contactId: selectedContact.id,
      message: messageText,
      status: 'sent',
      timestamp: new Date().toISOString(),
      direction: 'outgoing',
      isBot: false
    };

    setMessages((prev) => [...prev, newMessage]);
    setContacts((prev) =>
      prev.map((c) =>
        c.id === selectedContact.id
          ? { ...c, lastMessage: messageText, lastMessageTime: new Date().toISOString(), messageCount: c.messageCount + 1 }
          : c
      )
    );
    setMessageText('');
  };

  const handleBotMode = (type: RequestType) => {
    setBotRequestType(type);
    setBotStep(0);
    setBotMode(true);
  };

  const handleBotResponse = () => {
    if (!selectedContact) return;
    const conversations = BOT_CONVERSATIONS[botRequestType];
    if (botStep < conversations.length) {
      const botMessage: WhatsAppMessage = {
        id: uid(),
        contactId: selectedContact.id,
        message: conversations[botStep],
        status: 'delivered',
        timestamp: new Date().toISOString(),
        direction: 'incoming',
        isBot: true
      };
      setMessages((prev) => [...prev, botMessage]);
      setBotStep((prev) => prev + 1);

      if (botStep === conversations.length - 1) {
        setTimeout(() => {
          const newRequest: BotRequest = {
            id: uid(),
            contactId: selectedContact.id,
            contactName: selectedContact.name,
            contactPhone: selectedContact.phone,
            type: botRequestType,
            details: {},
            status: 'pending',
            createdAt: new Date().toISOString()
          };
          setBotRequests((prev) => [...prev, newRequest]);
          setBotMode(false);
        }, 500);
      }
    }
  };

  const handleCloseBotMode = () => {
    setBotMode(false);
    setBotStep(0);
  };

  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
  const generateAIResponse = (userMessage: string): string => {
    const lowerMsg = userMessage.toLowerCase();
    
    // ÙƒØ´Ù Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±
    if (lowerMsg.includes('Ø­Ø¬Ø²') || lowerMsg.includes('ØºØ±ÙØ©') || lowerMsg.includes('Ø­Ø¬ÙˆØ²Ø§Øª')) {
      return 'ğŸ¨ ÙŠØ³Ø¹Ø¯Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²! Ù„Ø¯ÙŠÙ†Ø§ ØºØ±Ù Ù…ØªØ§Ø­Ø© Ø¨Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ©. Ù…Ø§ Ù‡Ùˆ Ù†ÙˆØ¹ Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ù…ÙØ¶Ù„ Ù„Ø¯ÙŠÙƒØŸ (Ø³ØªØ§Ù†Ø¯Ø±Ø¯ØŒ Ø¯ÙŠÙ„ÙˆÙƒØ³ØŒ Ø³ÙˆÙŠØª)';
    }
    
    if (lowerMsg.includes('Ø³Ø¹Ø±') || lowerMsg.includes('ÙƒÙ…') || lowerMsg.includes('ØªÙƒÙ„ÙØ©')) {
      return 'ğŸ’° Ø£Ø³Ø¹Ø§Ø±Ù†Ø§ ØªØ¨Ø¯Ø£ Ù…Ù†:\nâ€¢ ØºØ±ÙØ© Ø³ØªØ§Ù†Ø¯Ø±Ø¯: 500 Ø±ÙŠØ§Ù„\nâ€¢ ØºØ±ÙØ© Ø¯ÙŠÙ„ÙˆÙƒØ³: 750 Ø±ÙŠØ§Ù„\nâ€¢ Ø³ÙˆÙŠØª: 1200 Ø±ÙŠØ§Ù„\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø¹Ø±ÙØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø¹Ù† Ø£ÙŠ Ù†ÙˆØ¹ Ù…Ø¹ÙŠÙ†ØŸ';
    }
    
    if (lowerMsg.includes('ØªÙ†Ø¸ÙŠÙ') || lowerMsg.includes('Ù†Ø¸Ø§ÙØ©') || lowerMsg.includes('ØªØ±ØªÙŠØ¨')) {
      return 'ğŸ§¹ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙØ±ÙŠÙ‚ Ø§Ù„ØªÙ†Ø¸ÙŠÙ ÙÙˆØ±Ø§Ù‹! Ù…Ø§ Ø±Ù‚Ù… ØºØ±ÙØªÙƒ Ù…Ù† ÙØ¶Ù„ÙƒØŸ';
    }
    
    if (lowerMsg.includes('Ø´ÙƒÙˆÙ‰') || lowerMsg.includes('Ù…Ø´ÙƒÙ„Ø©') || lowerMsg.includes('Ø¹Ø·Ù„')) {
      return 'ğŸ˜” Ù†Ø£Ø³Ù Ù„Ø­Ø¯ÙˆØ« Ø°Ù„Ùƒ! Ø³Ù†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙÙˆØ±Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù„Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.';
    }
    
    if (lowerMsg.includes('ÙƒÙˆÙÙŠ') || lowerMsg.includes('Ù‚Ù‡ÙˆØ©') || lowerMsg.includes('Ø·Ø¹Ø§Ù…')) {
      return 'â˜• Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ÙƒÙˆÙÙŠ Ø´ÙˆØ¨! Ù‚Ø§Ø¦Ù…ØªÙ†Ø§ ØªØ´Ù…Ù„:\nâ€¢ Ù‚Ù‡ÙˆØ© Ø¹Ø±Ø¨ÙŠØ©\nâ€¢ Ù‚Ù‡ÙˆØ© Ø¥Ø³Ø¨Ø±ÙŠØ³Ùˆ\nâ€¢ ÙƒØ§Ø¨ØªØ´ÙŠÙ†Ùˆ\nâ€¢ ÙˆØ¬Ø¨Ø§Øª Ø®ÙÙŠÙØ©\n\nÙ…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªØ·Ù„Ø¨ØŸ';
    }
    
    if (lowerMsg.includes('ÙˆØ§ÙŠ ÙØ§ÙŠ') || lowerMsg.includes('wifi') || lowerMsg.includes('Ø§Ù†ØªØ±Ù†Øª')) {
      return 'ğŸ“¶ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„ÙˆØ§ÙŠ ÙØ§ÙŠ:\nØ§Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ©: SmartHost_Guest\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: Welcome2024\n\nØ¥Ø°Ø§ ÙˆØ§Ø¬Ù‡Øª Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø®Ø¨Ø§Ø±Ù†Ø§!';
    }
    
    if (lowerMsg.includes('Ø´ÙƒØ±Ø§') || lowerMsg.includes('ØªØ³Ù„Ù…') || lowerMsg.includes('Ù…Ù…ØªØ§Ø²')) {
      return 'ğŸ™ Ø§Ù„Ø¹ÙÙˆ! Ù†Ø­Ù† Ø³Ø¹Ø¯Ø§Ø¡ Ø¨Ø®Ø¯Ù…ØªÙƒ Ø¯Ø§Ø¦Ù…Ø§Ù‹. Ù„Ø§ ØªØªØ±Ø¯Ø¯ ÙÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª!';
    }
    
    // Ø±Ø¯ Ø¹Ø§Ù…
    return 'ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ\n\nğŸ”¹ Ø­Ø¬Ø² ØºØ±ÙØ©\nğŸ”¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø¹Ø±ÙˆØ¶\nğŸ”¹ Ø®Ø¯Ù…Ø© Ø§Ù„ØºØ±Ù\nğŸ”¹ Ø§Ù„ÙƒÙˆÙÙŠ Ø´ÙˆØ¨\nğŸ”¹ Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ø³ØªÙØ³Ø§Ø±Ø§Øª';
  };

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© AI
  const handleAIResponse = () => {
    if (!selectedContact) return;
    
    const lastMessage = contactMessages[contactMessages.length - 1];
    if (!lastMessage || lastMessage.direction === 'outgoing') return;
    
    const aiResponse = generateAIResponse(lastMessage.message);
    
    const aiMessage: WhatsAppMessage = {
      id: uid(),
      contactId: selectedContact.id,
      message: aiResponse,
      status: 'sent',
      timestamp: new Date().toISOString(),
      direction: 'outgoing',
      isBot: false,
      aiGenerated: true,
      employeeId: 'ai_bot',
      employeeName: 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ'
    };
    
    setMessages((prev) => [...prev, aiMessage]);
    setContacts((prev) =>
      prev.map((c) =>
        c.id === selectedContact.id
          ? { ...c, lastMessage: aiResponse, lastMessageTime: new Date().toISOString(), messageCount: c.messageCount + 1 }
          : c
      )
    );
  };

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´ÙƒÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
  const handleCreateIssue = () => {
    if (!newIssue.title || !newIssue.description || !selectedContact) return;
    
    const issue: Issue = {
      id: uid(),
      contactId: selectedContact.id,
      title: newIssue.title,
      description: newIssue.description,
      status: 'open',
      priority: newIssue.priority,
      category: newIssue.category,
      assignedEmployeeId: selectedEmployeeId || undefined,
      createdAt: new Date().toISOString(),
      solutionSteps: [],
      relatedChatIds: [selectedContactId || ''],
      frequency: 1
    };
    
    setIssues((prev) => [...prev, issue]);
    setShowIssueDialog(false);
    setNewIssue({ title: '', description: '', category: '', priority: 'medium' });
  };

  // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ¸Ù
  const handleEmployeeStatusChange = (employeeId: string, newStatus: EmployeeStatus) => {
    setEmployees((prev) =>
      prev.map((e) =>
        e.id === employeeId
          ? { ...e, status: newStatus, lastActive: new Date().toISOString() }
          : e
      )
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-950 via-purple-950 to-slate-900 p-2 sm:p-6" dir="rtl">
      <div className="mx-auto max-w-[1800px] space-y-4">
        {/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø­Ø³Ù‘Ù† */}
        <header className="bg-gradient-to-r from-purple-900/40 to-blue-900/40 backdrop-blur-md border border-purple-700/30 rounded-2xl p-4 sm:p-6 shadow-2xl">
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div className="space-y-2">
              <div className="flex items-center gap-3">
                <Button 
                  onClick={() => router.back()} 
                  variant="ghost" 
                  size="sm" 
                  className="text-slate-300 hover:text-white hover:bg-slate-800/50"
                >
                  <ArrowRight className="h-5 w-5" />
                </Button>
                <div className="flex items-center gap-3">
                  <div className="relative">
                    <MessageSquare className="h-10 w-10 text-green-400" />
                    <Sparkles className="h-5 w-5 text-yellow-400 absolute -top-1 -right-1 animate-pulse" />
                  </div>
                  <div>
                    <h1 className="text-2xl sm:text-4xl font-bold bg-gradient-to-r from-green-400 to-blue-400 bg-clip-text text-transparent">
                      Ù†Ø¸Ø§Ù… CRM Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
                    </h1>
                    <p className="text-xs sm:text-sm text-slate-400">Ø¥Ø¯Ø§Ø±Ø© Ø°ÙƒÙŠØ© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù…Ø¹ AI</p>
                  </div>
                </div>
              </div>
            </div>
            <div className="flex gap-2 flex-wrap">
              <Button onClick={handleAddContact} className="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white shadow-lg">
                <Plus className="h-4 w-4 mr-2" /> Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
              </Button>
              <Button onClick={() => setShowIssueDialog(true)} className="bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white shadow-lg">
                <AlertCircle className="h-4 w-4 mr-2" /> Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©
              </Button>
            </div>
          </div>
        </header>

        {/* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */}
        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3">
          <Card className="border-green-800/30 bg-gradient-to-br from-green-900/30 to-emerald-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-green-300 flex items-center gap-1">
                <Users className="h-3 w-3" /> Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.totalContacts}</p>
              <p className="text-xs text-green-400">Ù†Ø´Ø·: {stats.activeContacts}</p>
            </CardContent>
          </Card>
          
          <Card className="border-blue-800/30 bg-gradient-to-br from-blue-900/30 to-cyan-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-blue-300 flex items-center gap-1">
                <MessageSquare className="h-3 w-3" /> Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.totalMessages}</p>
              <p className="text-xs text-blue-400">Ø§Ù„ÙŠÙˆÙ…</p>
            </CardContent>
          </Card>

          <Card className="border-purple-800/30 bg-gradient-to-br from-purple-900/30 to-pink-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-purple-300 flex items-center gap-1">
                <Briefcase className="h-3 w-3" /> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.totalEmployees}</p>
              <p className="text-xs text-purple-400">Ù…ØªØ§Ø­: {stats.availableEmployees}</p>
            </CardContent>
          </Card>

          <Card className="border-amber-800/30 bg-gradient-to-br from-amber-900/30 to-orange-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-amber-300 flex items-center gap-1">
                <AlertCircle className="h-3 w-3" /> Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.totalIssues}</p>
              <p className="text-xs text-amber-400">Ù…ÙØªÙˆØ­: {stats.openIssues}</p>
            </CardContent>
          </Card>

          <Card className="border-rose-800/30 bg-gradient-to-br from-rose-900/30 to-red-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-rose-300 flex items-center gap-1">
                <ClipboardList className="h-3 w-3" /> Ø§Ù„Ø·Ù„Ø¨Ø§Øª
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.botRequests}</p>
              <p className="text-xs text-rose-400">Ø§Ù†ØªØ¸Ø§Ø±: {stats.pendingRequests}</p>
            </CardContent>
          </Card>

          <Card className="border-yellow-800/30 bg-gradient-to-br from-yellow-900/30 to-amber-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-yellow-300 flex items-center gap-1">
                <Star className="h-3 w-3" /> Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.avgSatisfaction.toFixed(1)}</p>
              <p className="text-xs text-yellow-400">Ù…Ù† 5.0</p>
            </CardContent>
          </Card>

          <Card className="border-teal-800/30 bg-gradient-to-br from-teal-900/30 to-cyan-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-teal-300 flex items-center gap-1">
                <Clock className="h-3 w-3" /> ÙˆÙ‚Øª Ø§Ù„Ø±Ø¯
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">{stats.avgResponseTime.toFixed(1)}</p>
              <p className="text-xs text-teal-400">Ø¯Ù‚ÙŠÙ‚Ø©</p>
            </CardContent>
          </Card>

          <Card className="border-indigo-800/30 bg-gradient-to-br from-indigo-900/30 to-blue-900/20 backdrop-blur-sm hover:scale-105 transition-transform">
            <CardHeader className="pb-2">
              <CardTitle className="text-xs text-indigo-300 flex items-center gap-1">
                <Activity className="h-3 w-3" /> Ø§Ù„Ù†Ø´Ø§Ø·
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold text-white">98%</p>
              <p className="text-xs text-indigo-400">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø­Ù„</p>
            </CardContent>
          </Card>
        </div>

        {/* Ø§Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© */}
        <div className="flex gap-2 overflow-x-auto pb-2 border-b border-purple-800/30">
          <Button 
            variant={activeTab === 'messages' ? 'default' : 'ghost'} 
            onClick={() => setActiveTab('messages')} 
            className={activeTab === 'messages' ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white shadow-lg' : 'text-slate-300 hover:text-white hover:bg-slate-800/50'}
          >
            <MessageSquare className="h-4 w-4 mr-2" /> Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª
          </Button>
          <Button 
            variant={activeTab === 'employees' ? 'default' : 'ghost'} 
            onClick={() => setActiveTab('employees')} 
            className={activeTab === 'employees' ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-lg' : 'text-slate-300 hover:text-white hover:bg-slate-800/50'}
          >
            <Users className="h-4 w-4 mr-2" /> Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
          </Button>
          <Button 
            variant={activeTab === 'analytics' ? 'default' : 'ghost'} 
            onClick={() => setActiveTab('analytics')} 
            className={activeTab === 'analytics' ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg' : 'text-slate-300 hover:text-white hover:bg-slate-800/50'}
          >
            <BarChart3 className="h-4 w-4 mr-2" /> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
          </Button>
          <Button 
            variant={activeTab === 'issues' ? 'default' : 'ghost'} 
            onClick={() => setActiveTab('issues')} 
            className={activeTab === 'issues' ? 'bg-gradient-to-r from-amber-600 to-orange-600 text-white shadow-lg' : 'text-slate-300 hover:text-white hover:bg-slate-800/50'}
          >
            <AlertCircle className="h-4 w-4 mr-2" /> Ø§Ù„Ù…Ø´Ø§ÙƒÙ„
          </Button>
          <Button 
            variant={activeTab === 'requests' ? 'default' : 'ghost'} 
            onClick={() => setActiveTab('requests')} 
            className={activeTab === 'requests' ? 'bg-gradient-to-r from-rose-600 to-red-600 text-white shadow-lg' : 'text-slate-300 hover:text-white hover:bg-slate-800/50'}
          >
            <ClipboardList className="h-4 w-4 mr-2" /> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆØª
          </Button>
        </div>

        {/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø§Øª */}
        {activeTab === 'messages' ? (
          <div className="grid grid-cols-1 gap-6 lg:grid-cols-4">
            <div className="lg:col-span-1">
              <Card className="border-slate-800 bg-slate-900/40">
                <CardHeader>
                  <CardTitle className="text-white">Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <Input 
                    placeholder="Ø¨Ø­Ø«..." 
                    value={searchTerm} 
                    onChange={(e) => setSearchTerm(e.target.value)} 
                    className="h-8 text-sm border-slate-700 bg-slate-950" 
                  />
                  <div className="max-h-96 overflow-y-auto space-y-2">
                    {filteredContacts.length === 0 ? (
                      <p className="text-slate-400 text-center py-4 text-xs">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ù‡Ø§Øª Ø§ØªØµØ§Ù„</p>
                    ) : (
                      filteredContacts.map((contact) => (
                        <div 
                          key={contact.id} 
                          onClick={() => setSelectedContactId(contact.id)} 
                          className={`p-2 rounded-lg border cursor-pointer transition ${
                            selectedContactId === contact.id 
                              ? 'border-green-500 bg-green-500/10' 
                              : 'border-slate-800 bg-slate-950/50 hover:border-slate-700'
                          }`}
                        >
                          <p className="text-xs font-semibold text-white truncate">{contact.name}</p>
                          <p className="text-xs text-slate-400">{contact.phone}</p>
                          <p className="text-xs text-slate-500 mt-1">{contact.messageCount} Ø±Ø³Ø§Ù„Ø©</p>
                        </div>
                      ))
                    )}
                  </div>
                </CardContent>
              </Card>
            </div>

            <div className="lg:col-span-3">
              {selectedContact ? (
                <Card className="border-slate-800 bg-slate-900/40 h-[600px] flex flex-col">
                  <CardHeader className="border-b border-slate-800">
                    <div className="flex items-center justify-between">
                      <div>
                        <CardTitle className="text-white">{selectedContact.name}</CardTitle>
                        <CardDescription className="text-slate-400">{selectedContact.phone}</CardDescription>
                      </div>
                      {!botMode && (
                        <div className="flex gap-1 flex-wrap justify-end">
                          {REQUEST_TYPES.map((req) => (
                            <Button 
                              key={req.value} 
                              size="sm" 
                              onClick={() => handleBotMode(req.value)} 
                              className="h-8 text-xs bg-blue-600 hover:bg-blue-700 text-white"
                            >
                              <Bot className="h-3 w-3 mr-1" /> {req.icon}
                            </Button>
                          ))}
                        </div>
                      )}
                    </div>
                  </CardHeader>
                  <CardContent className="flex-1 overflow-y-auto space-y-3 py-4">
                    {contactMessages.length === 0 ? (
                      <p className="text-slate-400 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p>
                    ) : (
                      contactMessages.map((msg) => (
                        <div key={msg.id} className={`flex ${msg.direction === 'outgoing' ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-xs p-3 rounded-lg text-sm ${
                            msg.direction === 'outgoing' 
                              ? 'bg-green-600/20 text-green-300 border border-green-500/20' 
                              : msg.isBot
                              ? 'bg-blue-600/10 text-blue-300 border border-blue-500/30'
                              : 'bg-slate-800/50 text-slate-300 border border-slate-700/50'
                          }`}>
                            <p>{msg.message}</p>
                            <p className="text-xs mt-1 opacity-70">{new Date(msg.timestamp).toLocaleTimeString('ar-EG')}</p>
                          </div>
                        </div>
                      ))
                    )}
                  </CardContent>
                  <div className="border-t border-slate-800 p-3">
                    {botMode ? (
                      <div className="space-y-2">
                        <p className="text-xs text-slate-300 mb-2">
                          Ø§Ù„Ø¨ÙˆØª: {REQUEST_TYPES.find((t) => t.value === botRequestType)?.label} ({botStep}/{BOT_CONVERSATIONS[botRequestType].length})
                        </p>
                        <div className="flex gap-2">
                          <Button 
                            onClick={handleBotResponse} 
                            size="sm" 
                            className="flex-1 bg-blue-600 hover:bg-blue-700 text-white"
                          >
                            Ø§Ù„Ø±Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ
                          </Button>
                          <Button 
                            onClick={handleCloseBotMode} 
                            size="sm" 
                            variant="outline" 
                            className="border-slate-700 text-slate-300 hover:bg-slate-800"
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    ) : (
                      <div className="flex gap-2">
                        <Textarea 
                          value={messageText} 
                          onChange={(e) => setMessageText(e.target.value)} 
                          placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." 
                          rows={2} 
                          className="flex-1 border-slate-700 bg-slate-950 resize-none text-sm text-white" 
                        />
                        <Button 
                          onClick={handleSendMessage} 
                          disabled={!messageText.trim()} 
                          className="bg-green-600 hover:bg-green-700 h-full text-white"
                        >
                          <Send className="h-4 w-4" />
                        </Button>
                      </div>
                    )}
                  </div>
                </Card>
              ) : (
                <Card className="border-slate-800 bg-slate-900/40 h-[600px] flex items-center justify-center">
                  <p className="text-slate-400">Ø§Ø®ØªØ± Ø¬Ù‡Ø© Ø§ØªØµØ§Ù„ Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                </Card>
              )}
            </div>
          </div>
        ) : (
          <Card className="border-slate-800 bg-slate-900/40">
            <CardHeader>
              <CardTitle className="text-white">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</CardTitle>
              <CardDescription className="text-slate-400">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¬Ù…Ø¹Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø¨ÙˆØª</CardDescription>
            </CardHeader>
            <CardContent>
              <div className="overflow-x-auto">
                <table className="w-full text-sm">
                  <thead>
                    <tr className="border-b border-slate-800">
                      <th className="text-right p-3 text-slate-300">Ø§Ù„Ø§Ø³Ù…</th>
                      <th className="text-right p-3 text-slate-300">Ø§Ù„Ù‡Ø§ØªÙ</th>
                      <th className="text-right p-3 text-slate-300">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</th>
                      <th className="text-right p-3 text-slate-300">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                      <th className="text-right p-3 text-slate-300">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    </tr>
                  </thead>
                  <tbody>
                    {botRequests.length === 0 ? (
                      <tr>
                        <td colSpan={5} className="p-4 text-center text-slate-400">
                          Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©
                        </td>
                      </tr>
                    ) : (
                      botRequests.map((req) => (
                        <tr key={req.id} className="border-b border-slate-800 hover:bg-slate-800/20 transition">
                          <td className="p-3 text-slate-300">{req.contactName}</td>
                          <td className="p-3 text-slate-400 text-xs">{req.contactPhone}</td>
                          <td className="p-3">
                            <span className="text-sm">
                              {REQUEST_TYPES.find((t) => t.value === req.type)?.icon}
                              {' '}
                              {REQUEST_TYPES.find((t) => t.value === req.type)?.label}
                            </span>
                          </td>
                          <td className="p-3">
                            <Badge className={`${
                              req.status === 'pending' 
                                ? 'bg-amber-500/20 text-amber-300' 
                                : req.status === 'processing' 
                                ? 'bg-blue-500/20 text-blue-300' 
                                : 'bg-emerald-500/20 text-emerald-300'
                            }`}>
                              {req.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : req.status === 'processing' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©' : 'Ù…ÙƒØªÙ…Ù„'}
                            </Badge>
                          </td>
                          <td className="p-3 text-slate-400">{new Date(req.createdAt).toLocaleDateString('ar-EG')}</td>
                        </tr>
                      ))
                    )}
                  </tbody>
                </table>
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  );
}
